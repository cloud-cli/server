<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="/assets/wds.css" />
    <style>
      .editor__content {
        min-height: calc(100vh - 15%);
      }

      .editor__console {
        min-height: calc(100vh - 90%);
      }
    </style>
  </head>
  <body class="wds-page">
    <div class="wds-editor">
      <div class="wds-editor__toolbar">
        <input type="checkbox" data-action="autosave" checked />
        <button class="wds-btn wds-btn__primary" data-action="save">Save</button>
        <button class="wds-btn wds-btn__secondary" data-action="compile">Compile</button>
      </div>
      <div class="wds-editor__content" id="editor"></div>
      <div class="wds-editor__console" id="console"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs/loader.js"></script>

    <script>
      require.config({
        paths: {
          vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs',
        },
      });

      function debounce(fn, wait) {
        let timeout;

        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      require(['vs/editor/editor.main'], async function () {
        const [_, name] = location.pathname.slice(1).split('/');
        const source = await fetch('/preset/' + name);

        const editor = monaco.editor.create(document.getElementById('editor'), {
          value: source.ok ? await source.text() : '',
          language: 'yaml',
          automaticLayout: true,
        });

        const save = () =>
          fetch('/preset/' + name, {
            method: 'POST',
            body: editor.getValue(),
          });

        const compile = async () => {
          const output = document.getElementById('console');
          output.innerText = '';

          const req = await fetch('/compile/' + name, {
            method: 'POST',
          });

          output.innerText = JSON.stringify(await req.json(), null, 2);
        };

        const toggleAutoSave = (event) => {
          window.autoSave = event.target.checked;
        };

        const actions = {
          save,
          compile,
          autosave: toggleAutoSave,
        };

        document.querySelectorAll('[data-action]').forEach((c) => {
          const action = c.dataset.action;

          if (actions[action]) {
            c.addEventListener('click', async (event) => {
              c.disabled = true;
              await actions[action](event);
              c.disabled = false;
            });
          }
        });

        const debouncedSave = debounce(save, 2000);
        editor.onDidChangeModelContent(() => {
          window.autoSave && debouncedSave();
        });
        window.editor = editor;
        window.autoSave = true;
      });
    </script>
  </body>
</html>
